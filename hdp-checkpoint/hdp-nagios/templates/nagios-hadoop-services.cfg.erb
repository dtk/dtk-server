<%hg_defs = scope.function_hdp_template_var("hostgroup_defs")-%>
# NAGIOS SERVER Check (status log update)
<%if hg_defs['nagios-server']['host_member_info'] and not scope.function_hdp_host(hg_defs['nagios-server']['host_member_info']).empty?-%>
define service {        
        hostgroup_name          nagios-server        
        use                     generic-service
        service_description     NAGIOS::Nagios status log staleness alert
        check_command           check_nagios!10!/var/nagios/status.dat!/usr/bin/nagios
        normal_check_interval   10
        retry_check_interval    1 
        max_check_attempts      2
}

# NAGIOS SERVER HDFS Checks
define service {
        hostgroup_name          nagios-server
        use                     generic-service
        service_description     HDFS::Percent DataNodes storage full alert
        check_command           check_aggregate!"DATANODE::Storage full alert"!10%!30%
        normal_check_interval   2
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          nagios-server
        use                     generic-service
        service_description     HDFS::Percent DataNodes down alert
        check_command           check_aggregate!"DATANODE::Process down alert"!10%!30%
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

# NAGIOS SERVER MAPREDUCE Checks

define service {
        hostgroup_name          nagios-server
        use                     generic-service
        service_description     MAPREDUCE::Percent TaskTrackers down alert
        check_command           check_aggregate!"TASKTRACKER::Process down alert"!10%!30%
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}
<%end-%>

# GANGLIA SERVER Checks
<%if hg_defs['ganglia-server']['host_member_info'] and not scope.function_hdp_host(hg_defs['ganglia-server']['host_member_info']).empty?-%>
define service {
        hostgroup_name          ganglia-server
        use                     generic-service
        service_description     GANGLIA::Ganglia [gmetad] Process down alert
        check_command           check_tcp!8651!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          ganglia-server
        use                     generic-service
        service_description     GANGLIA::Ganglia collector [gmond] Process down alert for slaves
        check_command           check_tcp!8660!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          ganglia-server
        use                     generic-service
        service_description     GANGLIA::Ganglia collector [gmond] Process down alert for namenode
        check_command           check_tcp!8661!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          ganglia-server
        use                     generic-service
        service_description     GANGLIA::Ganglia collector [gmond] Process down alert for jobtracker
        check_command           check_tcp!8662!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          ganglia-server
        use                     generic-service
        service_description     GANGLIA::Ganglia collector [gmond] Process down alert for hbasemaster
        check_command           check_tcp!8663!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}
<%end-%>

# HDFS Checks
<%if hg_defs['namenode']['host_member_info'] and not scope.function_hdp_host(hg_defs['namenode']['host_member_info']).empty?-%>
define service {        
        hostgroup_name          namenode        
        use                     generic-service
        service_description     NAMENODE::Namenode Host CPU utilization alert
        check_command           check_snmp_load!200%!250%
        normal_check_interval   5
        retry_check_interval    2 
        max_check_attempts      5
}

define service {
        hostgroup_name          namenode
        use                     generic-service
        service_description     NAMENODE::Namenode Memory and Swap utilization alert
        check_command           check_snmp_mem!99%,20%!100%,50%
        normal_check_interval   5
        retry_check_interval    2 
        max_check_attempts      5
}

define service {
        hostgroup_name          namenode
        use                     generic-service
        service_description     NAMENODE::Namenode Process down alert
        check_command           check_tcp!8020!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          namenode
        use                     generic-service
        service_description     HDFS::Corrupt/Missing blocks alert
        check_command           check_hdfs_blocks!50070!0%!0%
        normal_check_interval   5
        retry_check_interval    1 
        max_check_attempts      2
}

define service {
        hostgroup_name          namenode
        use                     generic-service
        service_description     HDFS::HDFS Capacity utilization alert
        check_command           check_hdfs_capacity!50070!80%!90%
        normal_check_interval   10
        retry_check_interval    1 
        max_check_attempts      2
}

define service {
        hostgroup_name          namenode
        use                     generic-service
        service_description     HDFS::Namenode RPC Latency alert
        check_command           check_rpcq_latency!NameNode!50070!3000!5000
        normal_check_interval   5
        retry_check_interval    1 
        max_check_attempts      5
}
<%end-%>

# MAPREDUCE Checks
<%if hg_defs['jobtracker']['host_member_info'] and not scope.function_hdp_host(hg_defs['jobtracker']['host_member_info']).empty?-%>
define service {
        hostgroup_name          jobtracker
        use                     generic-service
        service_description     JOBTRACKER::Jobtracker CPU utilization alert
        check_command           check_snmp_load!200%!250%
        normal_check_interval   5
        retry_check_interval    2 
        max_check_attempts      5
}

define service {
        hostgroup_name          jobtracker
        use                     generic-service
        service_description     JOBTRACKER::Jobtracker Memory and Swap utilization alert
        check_command           check_snmp_mem!99%,20%!100%,50%
        normal_check_interval   5
        retry_check_interval    2 
        max_check_attempts      5
}

define service {
        hostgroup_name          jobtracker
        use                     generic-service
        service_description     JOBTRACKER::Jobtracker Process down alert
        check_command           check_tcp!50030!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          jobtracker
        use                     generic-service
        service_description     MAPREDUCE::JobTracker RPC Latency alert
        check_command           check_rpcq_latency!JobTracker!50030!3000!5000
        normal_check_interval   5
        retry_check_interval    1 
        max_check_attempts      5
}
<%end-%>

# HDFS::DATANODE Checks
<%if hg_defs['slaves']['host_member_info'] and not scope.function_hdp_host(hg_defs['slaves']['host_member_info']).empty?-%>
define service {
        hostgroup_name          slaves
        use                     generic-service
        service_description     DATANODE::Process down alert
        check_command           check_tcp!50010!-w 1 -c 1
        normal_check_interval   2
        retry_check_interval    1 
        max_check_attempts      5
}

define service {
        hostgroup_name          slaves
        use                     generic-service
        service_description     DATANODE::Storage full alert
        check_command           check_snmp_storage!<%=scope.function_hdp_template_var("datanode_dir") %>!89%!90%
        normal_check_interval   10
        retry_check_interval    5
        max_check_attempts      1
}

# MAPREDUCE::TASKTRACKER Checks 
define service {
        hostgroup_name          slaves
        use                     generic-service
        service_description     TASKTRACKER::Process down alert
        check_command           check_tcp!50060!-w 1 -c 1
        normal_check_interval   1
        retry_check_interval    1 
        max_check_attempts      5
}
<%end-%>
